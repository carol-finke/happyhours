<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Happy Hours in Chicago</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    .filter-container {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      margin-bottom: 20px;
    }
    .filter-dropdown {
      width: 200px;
    }
    .selected-filters {
      margin-bottom: 20px;
    }
    .filter-badge {
      display: inline-block;
      background-color: #007bff;
      color: white;
      padding: 5px 10px;
      border-radius: 20px;
      margin-right: 5px;
      cursor: pointer;
    }
    .filter-badge .close {
      margin-left: 5px;
      font-size: 14px;
    }
    .card {
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      overflow: hidden;
      margin-bottom: 10px;
      padding: 10px;
      width: 300px;
    }
    .card-header {
      background: #f8f9fa;
      padding: 5px;
      font-weight: bold;
      font-size: 16px;
    }
    .card-body {
      padding: 5px;
    }
    .card-footer {
      background: #f8f9fa;
      padding: 5px;
      text-align: right;
    }
    .container {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }
    .main-content {
      display: flex;
    }
    .content {
      flex: 1;
    }
    #map {
      width: 400px;
      height: 100vh;
      position: fixed;
      right: 0;
      top: 0;
    }
    .select2-container--default .select2-selection--multiple .select2-selection__choice {
      background-color: #007bff;
      border: 1px solid #0056b3;
      border-radius: 4px;
      padding: 3px 10px;
      color: white;
    }
  </style>
</head>
<body>
  <div class="container mt-3">
    <h1 style="text-align: center; margin-top: 20px;">Happy Hours in Chicago</h1>
    
    <div class="filter-section">
      <form method="get" action="/happy_hours">
        <div class="filter-container">
          <div>
            <span class="filter-label">Neighborhood:</span>
            <select id="neighborhoods" name="neighborhoods[]" multiple="multiple" class="filter-dropdown">
              <% @restaurants.map(&:neighborhood).uniq.each do |neighborhood| %>
                <option value="<%= neighborhood %>" <%= 'selected' if params[:neighborhoods]&.include?(neighborhood) %>><%= neighborhood %></option>
              <% end %>
            </select>
          </div>

          <div>
            <span class="filter-label">Day:</span>
            <select id="days" name="days[]" multiple="multiple" class="filter-dropdown">
              <% ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'].each do |day| %>
                <option value="<%= day %>" <%= 'selected' if params[:days]&.include?(day) %>><%= day.capitalize %></option>
              <% end %>
            </select>
          </div>

          <div>
            <span class="filter-label">Sort by:</span>
            <select name="sort" class="filter-dropdown">
              <option value="day" <%= 'selected' if params[:sort] == 'day' %>>Day</option>
              <option value="neighborhood" <%= 'selected' if params[:sort] == 'neighborhood' %>>Neighborhood</option>
              <option value="price" <%= 'selected' if params[:sort] == 'price' %>>Price</option>
            </select>
          </div>

          <button type="submit" class="btn btn-primary">Apply Filters</button>
        </div>
      </form>

      <div class="selected-filters">
        <% if params[:neighborhoods].present? %>
          <% params[:neighborhoods].each do |neighborhood| %>
            <span class="filter-badge">
              <%= neighborhood %>
              <a href="<%= request.fullpath.sub(/neighborhoods%5B%5D=#{neighborhood}&?/, '') %>" class="close">&times;</a>
            </span>
          <% end %>
        <% end %>

        <% if params[:sort].present? %>
          <span class="filter-badge">
            <%= params[:sort].capitalize %>
            <a href="<%= request.fullpath.sub(/sort=#{params[:sort]}&?/, '') %>" class="close">&times;</a>
          </span>
        <% end %>

        <% if params[:days].present? %>
          <% params[:days].each do |day| %>
            <span class="filter-badge">
              <%= day.capitalize %>
              <a href="<%= request.fullpath.sub(/days%5B%5D=#{day}&?/, '') %>" class="close">&times;</a>
            </span>
          <% end %>
        <% end %>
      </div>
    </div>

    <div class="main-content">
      <div class="content">
        <div class="container">
          <% if @restaurants.present? %>
            <p>Found <%= @restaurants.count %> restaurants.</p>
            <% @restaurants.each do |restaurant| %>
              <div class="card">
                <div class="card-header">
                  <%= restaurant.name %>
                </div>
                <div class="card-body">
                  <p><strong>Address:</strong> <%= restaurant.address %></p>
                  <p><strong>Deal:</strong> <%= restaurant.deal %></p>
                  <p><strong>Monday:</strong> <%= restaurant.monday %></p>
                  <p><strong>Tuesday:</strong> <%= restaurant.tuesday %></p>
                  <p><strong>Wednesday:</strong> <%= restaurant.wednesday %></p>
                  <p><strong>Thursday:</strong> <%= restaurant.thursday %></p>
                  <p><strong>Friday:</strong> <%= restaurant.friday %></p>
                  <p><strong>Saturday:</strong> <%= restaurant.saturday %></p>
                  <p><strong>Sunday:</strong> <%= restaurant.sunday %></p>
                </div>
                <div class="card-footer">
                  <a href="<%= restaurant.link %>" class="btn btn-primary btn-sm">Visit Website</a>
                </div>
              </div>
            <% end %>
          <% else %>
            <p>No restaurants found.</p>
          <% end %>
        </div>
      </div>

      <div id="map"></div>
    </div>
  </div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const map = L.map('map').setView([41.8781, -87.6298], 12);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
      }).addTo(map);

      const restaurants = <%= raw @restaurants.to_json %>;
      console.log(restaurants); // Debug output
      restaurants.forEach(restaurant => {
        if (restaurant.latitude && restaurant.longitude) {
          L.marker([restaurant.latitude, restaurant.longitude]).addTo(map)
            .bindPopup(`<b>${restaurant.name}</b><br>${restaurant.address}`);
        }
      });

      $('#neighborhoods, #days').select2({
        placeholder: 'Select an option',
        allowClear: true
      });
    });
  </script>
</body>
</html>
